---

- name: "MEDIUM | UBTU-18-010002 | PATCH | The Ubuntu operating system must initiate session audits at system startup."
  block:
      - name: "MEDIUM | UBTU-18-010002 | AUDIT | The Ubuntu operating system must initiate session audits at system startup. | Get GRUB_CMDLINE_LINUX"
        shell: grep "GRUB_CMDLINE_LINUX=" /etc/default/grub | cut -f2 -d'"'
        changed_when: false
        failed_when: false
        register: ubtu_18_010002_cmdline_settings

      - name: "MEDIUM | UBTU-18-010002 | PATCH | The Ubuntu operating system must initiate session audits at system startup. | Add setting if audit doesn't exist"
        lineinfile:
            path: /etc/default/grub
            regexp: '^GRUB_CMDLINE_LINUX='
            line: 'GRUB_CMDLINE_LINUX="{{ ubtu_18_010002_cmdline_settings.stdout }} audit=1"'
        notify: update grub
        when: "'audit=' not in ubtu_18_010002_cmdline_settings.stdout"

      - name: "MEDIUM | UBTU-18-010002 | PATCH | The Ubuntu operating system must initiate session audits at system startup. | Add setting if audit exists"
        replace:
            path: /etc/default/grub
            regexp: 'audit=([0-9]+)'
            replace: 'audit=1'
        notify: update grub
        when: "'audit=' in ubtu_18_010002_cmdline_settings.stdout"
  when:
      - ubtu_18_010002
  tags:
      - UBTU-18-010002
      - CAT2
      - CCI-001464
      - SRG-OS-000254-GPOS-00095
      - SV-219149r610963_rule
      - V-219149
      - grub

- name: "MEDIUM | UBTU-18-010003 | AUDIT | Ubuntu operating systems handling data requiring data at rest protections must employ cryptographic mechanisms to prevent unauthorized disclosure and modification of the information at rest."
  block:
      - name: "MEDIUM | UBTU-18-010003 | AUDIT | Ubuntu operating systems handling data requiring data at rest protections must employ cryptographic mechanisms to prevent unauthorized disclosure and modification of the information at rest. | Get encrypted partitions"
        shell: more /etc/crypttab | sed 1d
        changed_when: false
        failed_when: false
        register: ubtu_18_010003_crypttab_status

      - name: "MEDIUM | UBTU-18-010003 | AUDIT | Ubuntu operating systems handling data requiring data at rest protections must employ cryptographic mechanisms to prevent unauthorized disclosure and modification of the information at rest. | Alert no partitions are encrypted"
        debug:
            msg:
                - "Warning!! There no encrypted partitions. Please make sure all permenant partitions are encrypted"
        when: ubtu_18_010003_crypttab_status.stdout | length == 0

      - name: "MEDIUM | UBTU-18-010003 | AUDIT | Ubuntu operating systems handling data requiring data at rest protections must employ cryptographic mechanisms to prevent unauthorized disclosure and modification of the information at rest. | Alert no partitions are encrypted"
        debug:
            msg:
                - "Warning!! Please review that no permenant partitions are missing. All permenant partitions need to be encrypted"
                - "{{ ubtu_18_010003_crypttab_status.stdout_lines }}"
        when: ubtu_18_010003_crypttab_status.stdout | length > 0
  when:
      - ubtu_18_010003
  tags:
      - UBTU-18-010003
      - CAT2
      - CCI-001199
      - CCI-002475
      - CCI-002476
      - SRG-OS-000185-GPOS-00079
      - SV-219150r610963_rule
      - V-219150
      - encryption
      - mounts

- name: "MEDIUM | UBTU-18-010016 | PATCH | Advance package Tool (APT) must be configured to prevent the installation of patches, service packs, device drivers, or Ubuntu operating system components without verification they have been digitally signed using a certificate that is recognized and approved by the organization."
  block:
      - name: "MEDIUM | UBTU-18-010016 | AUDIT | Advance package Tool (APT) must be configured to prevent the installation of patches, service packs, device drivers, or Ubuntu operating system components without verification they have been digitally signed using a certificate that is recognized and approved by the organization. | Find AllowUnauthenticated true"
        shell: "grep 'AllowUnauthenticated \"true\"' /etc/apt/apt.conf.d/* | cut -d: -f1"
        changed_when: false
        failed_when: false
        register: ubtu_18_010016_apt_allowunauthenticated_status

      - name: "MEDIUM | UBTU-18-010016 | PATCH | Advance package Tool (APT) must be configured to prevent the installation of patches, service packs, device drivers, or Ubuntu operating system components without verification they have been digitally signed using a certificate that is recognized and approved by the organization. | Fix AllowUnauthenticated to false"
        replace:
            path: "{{ item }}"
            regexp: 'AllowUnauthenticated "true"'
            replace: 'AllowUnauthenticated "false"'
        with_items:
            - "{{ ubtu_18_010016_apt_allowunauthenticated_status.stdout_lines }}"
        when: ubtu_18_010016_apt_allowunauthenticated_status.stdout | length > 0
  when:
      - ubtu_18_010016
  tags:
      - UBTU-18-010016
      - CAT2
      - CCI-001749
      - SRG-OS-000366-GPOS-00153
      - SV-219155r610963_rule
      - V-219155
      - apt

- name: "MEDIUM | UBTU-18-010017 | PATCH | The Ubuntu operating system must be configured so that Advance package Tool (APT) removes all software components after updated versions have been installed."
  block:
      - name: "MEDIUM | UBTU-18-010017 | AUDIT | The Ubuntu operating system must be configured so that Advance package Tool (APT) removes all software components after updated versions have been installed. | Find Remove-Unused-Kernel-Packages"
        shell: "grep -i 'remove-unused-kernel-packages \"false\"' /etc/apt/apt.conf.d/* | cut -d: -f1"
        changed_when: false
        failed_when: false
        register: ubtu_18_010017_remove_unused_kernel_packages_status

      - name: "MEDIUM | UBTU-18-010017 | AUDIT | The Ubuntu operating system must be configured so that Advance package Tool (APT) removes all software components after updated versions have been installed. | Find Remove-Unused-Dependencies"
        shell: "grep -i 'remove-unused-dependencies \"false\"' /etc/apt/apt.conf.d/* | cut -d: -f1"
        changed_when: false
        failed_when: false
        register: ubtu_18_010017_remove_unused_dependencies_status

      - name: "MEDIUM | UBTU-18-010017 | PATCH | The Ubuntu operating system must be configured so that Advance package Tool (APT) removes all software components after updated versions have been installed. | Set Remove-Unused-Kernel-Packages"
        lineinfile:
            path: "{{ item.path }}"
            regexp: "{{ item.regexp }}"
            line: "{{ item.line }}"
            create: true
            mode: 644
            owner: root
            group: root
        with_items:
            - { path: "{{ (ubtu_18_010017_remove_unused_kernel_packages_status.stdout | length == 0 ) | ternary('/etc/apt/apt.conf.d/50unattended-upgrades',ubtu_18_010017_remove_unused_kernel_packages_status.stdout) }}", regexp: 'Unattended-Upgrade::Remove-Unused-Kernel-Packages', line: 'Unattended-Upgrade::Remove-Unused-Kernel-Packages "true";' }
            - { path: "{{ (ubtu_18_010017_remove_unused_dependencies_status.stdout | length == 0 ) | ternary('/etc/apt/apt.conf.d/50unattended-upgrades',ubtu_18_010017_remove_unused_dependencies_status.stdout) }}", regexp: 'Unattended-Upgrade::Remove-Unused-Dependencies', line: 'Unattended-Upgrade::Remove-Unused-Dependencies "true";' }
        loop_control:
            label: "{{ item.line }}"
  when:
      - ubtu_18_010017
  tags:
      - UBTU-18-010017
      - CAT2
      - CCI-002617
      - SRG-OS-000437-GPOS-00194
      - SV-219156r610963_rule
      - V-219156
      - apt

# There is no mfetp package available. The McAfee instructions have you download the installer from their portal. This package may no longer be available
# - name: "MEDIUM | UBTU-18-010021 | PATCH | The Ubuntu operating system must deploy Endpoint Security for Linux Threat Prevention (ENSLTP)."
#   package:
#       name: mfetp
#       state: present
#   when:
#       - ubtu_18_010021
#       - '"mfetp" not in ansible_facts.packages'
#   tags:
#       - UBTU-18-010021
#       - CAT2
#       - CCI-001233
#       - SRG-OS-000191-GPOS-00080
#       - SV-219159r610963_rule
#       - V-219159
#       - ensltp

- name: "MEDIUM | UBTU-18-010022 | PATCH | The Ubuntu operating system must be configured to preserve log records from failure events."
  service:
      name: rsyslog
      state: started
      enabled: true
  when:
      - ubtu_18_010022
  tags:
      - UBTU-18-010022
      - CAT2
      - CCI-001665
      - SRG-OS-000269-GPOS-00103
      - SV-219160r610963_rule
      - V-219160
      - rsyslog

- name: "MEDIUM | UBTU-18-010023 | PATCH | The Ubuntu operating system must have an application firewall installed in order to control remote access methods."
  package:
      name: ufw
      state: present
  when:
      - ubtu_18_010023
  tags:
      - UBTU-18-010023
      - CAT2
      - CCI-002314
      - SRG-OS-000297-GPOS-00115
      - SV-219161r610963_rule
      - V-219161
      - ufw
      - firewall

- name: "MEDIUM | UBTU-18-010033 | PATCH | The Ubuntu operating system must be configured so that three consecutive invalid logon attempts by a user automatically locks the account until released by an administrator."
  block:
      - name: "MEDIUM | UBTU-18-010033 | AUDIT | The Ubuntu operating system must be configured so that three consecutive invalid logon attempts by a user automatically locks the account until released by an administrator. | Find pam_faillock.so authfail"
        shell: 'grep "auth.*\[default=die\].*pam_faillock.so" /etc/pam.d/common-auth'
        changed_when: false
        failed_when: false
        register: ubtu_18_010033_authfail_status

      - name: "MEDIUM | UBTU-18-010033 | AUDIT | The Ubuntu operating system must be configured so that three consecutive invalid logon attempts by a user automatically locks the account until released by an administrator. | Find pam_faillock.so authsucc"
        shell: grep "auth.*sufficient.*pam_faillock.so" /etc/pam.d/common-auth
        changed_when: false
        failed_when: false
        register: ubtu_18_010033_authsucc_status

      - name: "MEDIUM | UBTU-18-010033 | PATCH | The Ubuntu operating system must be configured so that three consecutive invalid logon attempts by a user automatically locks the account until released by an administrator. | Set if authsucc doesn't exist"
        pamd:
            name: common-auth
            type: "{{ ubtu18stig_pamd_faillock.type }}"
            control: "{{ ubtu18stig_pamd_faillock.control }}"
            module_path: "{{ ubtu18stig_pamd_faillock.module_path }}"
            new_type: auth
            new_control: sufficient
            new_module_path: pam_faillock.so
            module_arguments: authsucc
            state: "{{ ubtu18stig_pamd_faillock.state }}"
        when: ubtu_18_010033_authsucc_status.stdout | length == 0

      - name: "MEDIUM | UBTU-18-010033 | PATCH | The Ubuntu operating system must be configured so that three consecutive invalid logon attempts by a user automatically locks the account until released by an administrator. | Set if authfail doesn't exist"
        pamd:
            name: common-auth
            type: "{{ ubtu18stig_pamd_faillock.type }}"
            control: "{{ ubtu18stig_pamd_faillock.control }}"
            module_path: "{{ ubtu18stig_pamd_faillock.module_path }}"
            new_type: auth
            new_control: "[default=die]"
            new_module_path: pam_faillock.so
            module_arguments: authfail
            state: "{{ ubtu18stig_pamd_faillock.state }}"
        when: ubtu_18_010033_authfail_status.stdout | length == 0

      - name: "MEDIUM | UBTU-18-010033 | PATCH | The Ubuntu operating system must be configured so that three consecutive invalid logon attempts by a user automatically locks the account until released by an administrator. | Set authsucc does exist"
        pamd:
            name: common-auth
            type: auth
            control: sufficient
            module_path: pam_faillock.so
            module_arguments: authsucc
            state: args_present
        when: ubtu_18_010033_authsucc_status.stdout | length > 0

      - name: "MEDIUM | UBTU-18-010033 | PATCH | The Ubuntu operating system must be configured so that three consecutive invalid logon attempts by a user automatically locks the account until released by an administrator. | Set if authfail does exist"
        pamd:
            name: common-auth
            type: auth
            control: "[default=die]"
            module_path: pam_faillock.so
            module_arguments: authfail
            state: args_present
        when: ubtu_18_010033_authfail_status.stdout | length > 0

      - name: "MEDIUM | UBTU-18-010033 | PATCH | The Ubuntu operating system must be configured so that three consecutive invalid logon attempts by a user automatically locks the account until released by an administrator. | Update faillock.conf"
        lineinfile:
            path: /etc/security/faillock.conf
            regexp: "{{ item.regexp }}"
            line: "{{ item.line }}"
        with_items:
            - { regexp: '^#.*audit', line: audit }
            - { regexp: '^#.*silent', line: silent }
            - { regexp: '^deny.*=|^#.*deny.*=', line: "deny = {{ ubtu18stig_pamd_faillock.deny }}" }
            - { regexp: '^fail_interval.*=|^#.*fail_interval.*=', line: "fail_interval = {{ ubtu18stig_pamd_faillock.fail_interval }}" }
            - { regexp: '^unlock_time.*=|^#.*unlock_time.*=', line: "unlock_time = 0" }
  when:
      - ubtu_18_010033
  tags:
      - UBTU-18-010033
      - CAT2
      - CCI-000044
      - CCI-002238
      - SRG-OS-000021-GPOS-00005
      - SV-219166r802355_rule
      - V-219166
      - pamd

- name: "MEDIUM | UBTU-18-010035 | PATCH | The Ubuntu operating system must display the Standard Mandatory DoD Notice and Consent Banner before granting local access to the system via a graphical user logon. | Set banner settings"
  lineinfile:
      path: /etc/gdm3/greeter.dconf-defaults
      regexp: "{{ item.regexp }}"
      line: "{{ item.line }}"
      insertafter: "{{ item.insertafter }}"
      create: true
      owner: root
      group: root
      mode: 0644
  notify:
      - reload gdm
      - dconf update
  with_items:
      - { regexp: '\[org\/gnome\/login-screen\]', line: '[org/gnome/login-screen]', insertafter: EOF }
      - { regexp: 'banner-message-enable', line: 'banner-message-enable=true', insertafter: '\[org\/gnome\/login-screen\]'}
      - { regexp: 'banner-message-text', line: 'banner-message-text={{ ubtu18cis_warning_banner }}', insertafter: 'banner-message-enable' }
  loop_control:
      label: "{{ item.regexp }}"
  when:
      - ubtu_18_010035
      - ubtu18cis_desktop_required
  tags:
      - UBTU-18-010035
      - CAT2
      - CCI-000050
      - SRG-OS-000024-GPOS-00007
      - SV-219167r610963_rule
      - V-219167
      - banner

- name: "MEDIUM | UBTU-18-010036 | PATCH | The Ubuntu operating system must prevent direct login into the root account."
  user:
      name: root
      password_lock: true
  when:
      - ubtu_18_010036
  tags:
      - UBTU-18-010036
      - CAT2
      - CCI-000770
      - SRG-OS-000109-GPOS-00056
      - SV-219168r610963_rule
      - V-219168
      - accounts

- name: "MEDIUM | UBTU-18-010038 | PATCH | The Ubuntu operating system must display the Standard Mandatory DoD Notice and Consent Banner before granting any publically accessible connection to the system."
  block:
      - name: "MEDIUM | UBTU-18-010038 | PATCH | The Ubuntu operating system must display the Standard Mandatory DoD Notice and Consent Banner before granting any publically accessible connection to the system. | Uncomment banner keyword and set banner path"
        lineinfile:
            path: /etc/ssh/sshd_config
            regexp: '(?i)^#?Banner'
            line: Banner /etc/issue
        when:
            - ubtu18stig_ssh_required

      - name: "MEDIUM | UBTU-18-010038 | PATCH | The Ubuntu operating system must display the Standard Mandatory DoD Notice and Consent Banner before granting any publically accessible connection to the system. | Set banner message"
        copy:
            dest: "{{ item }}"
            content: "{{ ubtu18cis_warning_banner }}"
            owner: root
            group: root
            mode: '0644'
        notify: restart sshd
        with_items:
            - /etc/issue
            - /etc/issue.net
  when:
      - ubtu_18_010038
      - ubtu18stig_ssh_required
  tags:
      - UBTU-18-010038
      - CAT2
      - CCI-000048
      - CCI-001384
      - CCI-001385
      - CCI-001386
      - CCI-001387
      - CCI-001388
      - SRG-OS-000228-GPOS-00088
      - SV-219170r610963_rule
      - V-219170
      - banner

- name: "MEDIUM | UBTU-18-010104 | PATCH | The Ubuntu operating system must encrypt all stored passwords with a FIPS 140-2 approved cryptographic hashing algorithm."
  lineinfile:
      path: /etc/login.defs
      regexp: '^ENCRYPT_METHOD.*'
      line: "ENCRYPT_METHOD {{ ubtu18stig_login_defaults.encrypt_method | default('SHA512') }}"
  when:
      - ubtu_18_010104
  tags:
      - UBTU-18-010104
      - CAT2
      - CCI-000196
      - SRG-OS-000073-GPOS-00041
      - SV-219176r610963_rule
      - V-219176
      - fips
      - encryption

- name: "MEDIUM | UBTU-18-010109 | PATCH | The Ubuntu operating system must enforce a minimum 15-character password length."
  lineinfile:
      path: /etc/security/pwquality.conf
      regexp: '^#?\s*minlen'
      line: "minlen = {{ ubtu18stig_password_complexity.minlen | default('15') }}"
      create: true
      owner: root
      group: root
      mode: 0644
  when:
      - ubtu_18_010109
  tags:
      - UBTU-18-010109
      - CAT2
      - CCI-000205
      - SRG-OS-000078-GPOS-00046
      - SV-219181r610963_rule
      - V-219181
      - accounts

- name: "MEDIUM | UBTU-18-010110 | PATCH | The Ubuntu operating system must employ a FIPS 140-2 approved cryptographic hashing algorithms for all created and stored passwords."
  block:
      - name: "MEDIUM | UBTU-18-010110 | AUDIT | The Ubuntu operating system must employ a FIPS 140-2 approved cryptographic hashing algorithms for all created and stored passwords. | Get status of pam_unix.so"
        shell: grep 'password.*{{ ubtu18stig_pamd_encryption.new_control }}.*pam_unix.so' /etc/pam.d/common-password
        changed_when: false
        failed_when: false
        register: ubtu_18_010110_pam_unix_so

      - name: "MEDIUM | UBTU-18-010110 | PATCH | The Ubuntu operating system must employ a FIPS 140-2 approved cryptographic hashing algorithms for all created and stored passwords. | Add encryption if pam_unix exists"
        pamd:
            name: common-password
            type: password
            control: "{{ ubtu18stig_pamd_encryption.new_control }}"
            module_path: pam_unix.so
            module_arguments: "{{ ubtu18stig_pamd_encryption.encryption }}"
            state: args_present
        when: ubtu_18_010110_pam_unix_so.stdout | length > 0

      - name: "MEDIUM | UBTU-18-010110 | PATCH | The Ubuntu operating system must employ a FIPS 140-2 approved cryptographic hashing algorithms for all created and stored passwords. | Add encryption if pam_unix doesn't exists"
        pamd:
            name: common-password
            type: "{{ ubtu18stig_pamd_encryption.type }}"
            control: "{{ ubtu18stig_pamd_encryption.control }}"
            module_path: "{{ ubtu18stig_pamd_encryption.module_path }}"
            new_type: password
            new_control: "{{ ubtu18stig_pamd_encryption.new_control }}"
            new_module_path: pam_unix.so
            module_arguments: "{{ ubtu18stig_pamd_encryption.encryption }}"
            state: "{{ ubtu18stig_pamd_encryption.state }}"
        when: ubtu_18_010110_pam_unix_so.stdout | length == 0

      - name: "MEDIUM | UBTU-18-010110 | PATCH | The Ubuntu operating system must employ a FIPS 140-2 approved cryptographic hashing algorithms for all created and stored passwords. | Add ENCRYPT_METHOD"
        lineinfile:
            path: /etc/login.defs
            regexp: '^ENCRYPT_METHOD'
            line: "ENCRYPT_METHOD {{ ubtu18stig_login_defaults.encrypt_method }}"
  when:
      - ubtu_18_010110
  tags:
      - UBTU-18-010110
      - CAT2
      - CCI-000803
      - SRG-OS-000120-GPOS-00061
      - SV-219182r610963_rule
      - V-219182
      - pamd
      - encryption

- name: "MEDIUM | UBTU-18-010112 | AUDIT | The Ubuntu operating system must allow the use of a temporary password for system logons with an immediate change to a permanent password."
  debug:
      msg:
          - "Warning!! Please create a policy that ensures when a user is created, it is created using a method that forces a user to change their password upon their next login."
          - 'For example: "chage -d 0 [UserName]" or "passwd -e [UserName]"'
  when:
      - ubtu_18_010112
  tags:
      - UBTU-18-010112
      - CAT2
      - CCI-002041
      - SRG-OS-000380-GPOS-00165
      - SV-219183r610963_rule
      - V-219183
      - passwords
      - accounts

- name: "MEDIUM | UBTU-18-010113 | PATCH | The Ubuntu operating system must prevent the use of dictionary words for passwords."
  lineinfile:
      path: /etc/security/pwquality.conf
      regexp: '^dictcheck='
      line: 'dictcheck={{ ubtu18stig_password_complexity.dictcheck }}'
      create: true
      owner: root
      group: root
      mode: 0644
  when:
      - ubtu_18_010113
  tags:
      - UBTU-18-010113
      - CAT2
      - CCI-000366
      - SRG-OS-000480-GPOS-00225
      - SV-219184r610963_rule
      - V-219184
      - passwords

- name: "MEDIUM | UBTU-18-010114 | PATCH | The Ubuntu operating system must require users to re-authenticate for privilege escalation and changing roles."
  replace:
      path: /etc/sudoers
      regexp: "{{ item.regexp }}"
      replace: "{{ item.replace }}"
  with_items:
      - { regexp: '^([^#|{% if system_is_ec2 %}ec2-user{% endif %}].*)NOPASSWD(.*)', replace: '\1PASSWD\2' }
      - { regexp: '^([^#].*)!authenticate(.*)', replace: '\1authenticate\2' }
  loop_control:
      label: "{{ item.replace }}"
  when:
      - ubtu_18_010114
  tags:
      - UBTU-18-010114
      - CAT2
      - CCI-002038
      - SRG-OS-000373-GPOS-00156
      - SV-219185r610963_rule
      - V-219185
      - sudo

- name: "MEDIUM | UBTU-18-010116 | PATCH | The Ubuntu Operating system must be configured so that when passwords are changed or new passwords are established, pwquality must be used."
  block:
      - name: "MEDIUM | UBTU-18-010116 | AUDIT | The Ubuntu Operating system must be configured so that when passwords are changed or new passwords are established, pwquality must be used. | Find the pamd settings"
        shell: grep 'password.*requisite.*pam_pwquality.so' /etc/pam.d/common-password
        changed_when: false
        failed_when: false
        register: ubtu_18_010116_pam_pwquality_so

      - name: "MEDIUM | UBTU-18-010116 | PATCH | The Ubuntu Operating system must be configured so that when passwords are changed or new passwords are established, pwquality must be used. | Add retry setting if exists"
        pamd:
            name: common-password
            type: password
            control: requisite
            module_path: pam_pwquality.so
            module_arguments: "retry={{ ubtu18stig_pam_pwquality_retry }}"
            state: args_present
        when: ubtu_18_010116_pam_pwquality_so.stdout | length > 0

      - name: "MEDIUM | UBTU-18-010116 | PATCH | The Ubuntu Operating system must be configured so that when passwords are changed or new passwords are established, pwquality must be used. | Add retry setting if doesn't exists"
        pamd:
            name: common-password
            type: "{{ ubtu18stig_pamd_retry.type }}"
            control: "{{ ubtu18stig_pamd_retry.control }}"
            module_path: "{{ ubtu18stig_pamd_retry.module_path }}"
            new_type: password
            new_control: requisite
            new_module_path: pam_pwquality.so
            module_arguments: "retry={{ ubtu18stig_pam_pwquality_retry }}"
            state: "{{ ubtu18stig_pamd_retry.state }}"
        when: ubtu_18_010116_pam_pwquality_so.stdout | length == 0

      - name: "MEDIUM | UBTU-18-010116 | PATCH | The Ubuntu Operating system must be configured so that when passwords are changed or new passwords are established, pwquality must be used. | Install libpam-pwquality"
        package:
            name: libpam-pwquality
            state: present
        when: "'libpam-pwquality' not in ansible_facts.packages"

      - name: "MEDIUM | UBTU-18-010116 | PATCH | The Ubuntu Operating system must be configured so that when passwords are changed or new passwords are established, pwquality must be used. | Set the enforcing setting"
        lineinfile:
            path: /etc/security/pwquality.conf
            regexp: '^enforcing =|^#.*enforcing ='
            line: 'enforcing ='
  when:
      - ubtu_18_010116
  tags:
      - UBTU-18-010116
      - CAT2
      - CCI-000366
      - SRG-OS-000480-GPOS-00225
      - SV-219186r610963_rule
      - V-219186
      - pamd
      - pwquality
      - login

- name: "MEDIUM | UBTU-18-010120 | PATCH | The Ubuntu operating system must set a sticky bit on all public directories to prevent unauthorized and unintended information transferred via shared system resources."
  block:
      - name: "MEDIUM | UBTU-18-010120 | PATCH | The Ubuntu operating system must set a sticky bit on all public directories to prevent unauthorized and unintended information transferred via shared system resources. | Find world-writable directories"
        shell: "find / -type d \\( -perm -002 ! -perm -1000 \\) -print 2>/dev/null | sed 's/.* //'"
        changed_when: false
        failed_when: false
        register: ubtu_18_010120_world_writable_directories

      - name: "MEDIUM | UBTU-18-010120 | PATCH | The Ubuntu operating system must set a sticky bit on all public directories to prevent unauthorized and unintended information transferred via shared system resources. | Add sticky bit to world-writable directories"
        file:
            path: "{{ item }}"
            mode: '1777'
        with_items:
            - "{{ ubtu_18_010120_world_writable_directories.stdout_lines }}"
        when: ubtu_18_010120_world_writable_directories.stdout | length > 0
  when:
      - ubtu_18_010120
  tags:
      - UBTU-18-010120
      - CAT2
      - CCI-001090
      - SRG-OS-000138-GPOS-00069
      - SV-219187r610963_rule
      - V-219187
      - permissions

- name: "MEDIUM | UBTU-18-010121 | PATCH | The Ubuntu operating system must generate error messages that provide information necessary for corrective actions without revealing information that could be exploited by adversaries."
  block:
      - name: "MEDIUM | UBTU-18-010121 | AUDIT | The Ubuntu operating system must generate error messages that provide information necessary for corrective actions without revealing information that could be exploited by adversaries. | Find if files exist"
        shell: find /var/log -perm /137 -type f -exec stat -c "%n %a" {} \;
        changed_when: false
        failed_when: false
        register: ubtu_18_010121_var_log_permissions

      - name: "MEDIUM | UBTU-18-010121 | PATCH | The Ubuntu operating system must generate error messages that provide information necessary for corrective actions without revealing information that could be exploited by adversaries. | Fix files"
        shell: find /var/log -perm /137 -type f -exec chmod 640 '{}' \;
        changed_when: true
        when: ubtu_18_010121_var_log_permissions.stdout | length > 0
  when:
      - ubtu_18_010121
  tags:
      - UBTU-18-010121
      - CAT2
      - CCI-001312
      - SRG-OS-000205-GPOS-00083
      - SV-219188r610963_rule
      - V-219188
      - permissions

- name: |
    "MEDIUM | UBTU-18-010122 | PATCH | The Ubuntu operating system must configure the /var/log directory to be group-owned by syslog."
    "MEDIUM | UBTU-18-010123 | PATCH | The Ubuntu operating system must configure the /var/log directory to be owned by root."
    "MEDIUM | UBTU-18-010124 | PATCH | The Ubuntu operating system must configure the /var/log directory to have mode 0750 or less permissive."
  file:
      path: /var/log
      owner: "{{ ubtu_18_010123 | ternary('root',omit) }}"
      group: "{{ ubtu_18_010122 | ternary('syslog',omit) }}"
      mode: "{{ ubtu_18_010124 | ternary(ubtu18cis_var_log_perms,omit) }}"
      state: directory
  when:
      - ubtu_18_010122 or
        ubtu_18_010123 or
        ubtu_18_010124
  tags:
      - UBTU-18-010122
      - UBTU-18-010123
      - UBTU-18-010124
      - CAT2
      - CCI-001314
      - SRG-OS-000206-GPOS-00084
      - SV-219189r610963_rule
      - SV-219190r610963_rule
      - SV-219191r610963_rule
      - V-219189
      - V-219190
      - V-219191
      - permissions

- name: |
    "MEDIUM | UBTU-18-010125 | PATCH | The Ubuntu operating system must configure the /var/log/syslog file to be group-owned by adm."
    "MEDIUM | UBTU-18-010126 | PATCH | he Ubuntu operating system must configure /var/log/syslog file to be owned by syslog."
    "MEDIUM | UBTU-18-010127 | PATCH | The Ubuntu operating system must configure /var/log/syslog file with mode 0640 or less permissive."
  file:
      path: /var/log/syslog
      owner: "{{ ubtu_18_010126 | ternary('syslog',omit) }}"
      group: "{{ ubtu_18_010125 | ternary('adm',omit) }}"
      mode: "{{ ubtu_18_010127 | ternary(ubtu18cis_var_log_syslog_perms,omit) }}"
      state: directory
  when:
      - ubtu_18_010125 or
        ubtu_18_010126 or
        ubtu_18_010127
  tags:
      - UBTU-18-010125
      - UBTU-18-010126
      - UBTU-18-010127
      - CAT2
      - CCI-001314
      - SRG-OS-000206-GPOS-00084
      - SV-219192r610963_rule
      - SV-219193r610963_rule
      - SV-219194r610963_rule
      - V-219192
      - V-219193
      - V-219194
      - permissions

- name: |
    "MEDIUM | UBTU-18-010128 | PATCH | The Ubuntu operating system must configure audit tools with a mode of 0755 or less permissive."
    "MEDIUM | UBTU-18-010129 | PATCH | The Ubuntu operating system must configure audit tools to be owned by root."
    "MEDIUM | UBTU-18-010130 | PATCH | The Ubuntu operating system must configure the audit tools to be group-owned by root."
  block:
      - name: |
          "MEDIUM | UBTU-18-010128 | PATCH | The Ubuntu operating system must configure audit tools with a mode of 0755 or less permissive. | Find tools with less than 755 perms"
          "MEDIUM | UBTU-18-010129 | PATCH | The Ubuntu operating system must configure audit tools to be owned by root."
          "MEDIUM | UBTU-18-010130 | PATCH | The Ubuntu operating system must configure the audit tools to be group-owned by root."
        shell: stat -c "%a %n" /sbin/auditctl, /sbin/aureport, /sbin/ausearch, /sbin/autrace, /sbin/auditd, /sbin/audispd, /sbin/augenrules | cut -f2 -d" "
        changed_when: false
        failed_when: false
        register: ubtu_18_010129_tools

      - name: |
          "MEDIUM | UBTU-18-010128 | PATCH | The Ubuntu operating system must configure audit tools with a mode of 0755 or less permissive. | Set permissions to 755 on tools"
          "MEDIUM | UBTU-18-010129 | PATCH | The Ubuntu operating system must configure audit tools to be owned by root."
          "MEDIUM | UBTU-18-010130 | PATCH | The Ubuntu operating system must configure the audit tools to be group-owned by root."
        file:
            path: "{{ item }}"
            owner: "{{ ubtu_18_010129 | ternary('root',omit) }}"
            group: "{{ ubtu_18_010130 | ternary('root',omit) }}"
            mode: "{{ ubtu_18_010128 | ternary(ubtu18cis_tool_perms,omit) }}"
        with_items:
            - "{{ ubtu_18_010129_tools.stdout_lines }}"
        when: ubtu_18_010129_tools.stdout | length > 0
  when:
      - ubtu_18_010128 or
        ubtu_18_010129 or
        ubtu_18_010130
  tags:
      - UBTU-18-010128
      - UBTU-18-010129
      - CAT2
      - CCI-001493
      - CCI-001494
      - CCI-001495
      - SRG-OS-000256-GPOS-00097
      - SV-219195r610963_rule
      - SV-219196r610963_rule
      - SV-219197r610963_rule
      - V-219195
      - V-219196
      - V-219197
      - permissions

- name: |
    "MEDIUM | UBTU-18-010133 | PATCH | The Ubuntu operating system library files must have mode 0755 or less permissive."
    "MEDIUM | UBTU-18-010135 | PATCH | The Ubuntu operating system library files must be owned by root."
    "MEDIUM | UBTU-18-010137 | PATCH | The Ubuntu operating system library files must be group-owned by root."
  block:
      - name: |
          "MEDIUM | UBTU-18-010133 | AUDIT | The Ubuntu operating system library files must have mode 0755 or less permissive. | Get library files with mode 0755 or less"
          "MEDIUM | UBTU-18-010135 | AUDIT | The Ubuntu operating system library files must be owned by root. | Get library files not owned by root"
          "MEDIUM | UBTU-18-010137 | AUDIT | The Ubuntu operating system library files must be group-owned by root. | Get library files not group-owned by root"
        shell: find /lib /lib64 /usr/lib \( ! -group root -o ! -user root -o -perm /022 \) -type f -exec stat -c "%n" '{}' \;
        changed_when: false
        failed_when: false
        register: ubtu_18_010133_lib_files

      - name: |
          "MEDIUM | UBTU-18-010133 | PATCH | The Ubuntu operating system library files must have mode 0755 or less permissive. | Set library files with mode 0755 or more restrictive"
          "MEDIUM | UBTU-18-010135 | PATCH | The Ubuntu operating system library files must be owned by root. | Set library files to be owned by root"
          "MEDIUM | UBTU-18-010137 | PATCH | The Ubuntu operating system library files must be group-owned by root. | Set library files not group-owned by root"
        file:
            path: "{{ item }}"
            owner: "{{ ubtu_18_010135 | ternary('root',omit) }}"
            group: "{{ ubtu_18_010137 | ternary('root',omit) }}"
            mode: "{{ ubtu_18_010133 | ternary(ubtu18stig_lib_file_perms,omit) }}"
        with_items:
            "{{ ubtu_18_010133_lib_files.stdout_lines }}"
        when: ubtu_18_010133_lib_files.stdout | length > 0
  when:
      - ubtu_18_010133 or
        ubtu_18_010135 or
        ubtu_18_010137
  tags:
      - UBTU-18-010133
      - UBTU-18-010135
      - UBTU-18-010137
      - CAT2
      - CCI-001499
      - SRG-OS-000259-GPOS-00100
      - SV-219198r802358_rule
      - SV-219200r610963_rule
      - SV-219202r802361_rule
      - V-219198
      - V-219200
      - V-219202
      - permissions

# - name: "MEDIUM | UBTU-18-010133 | PATCH | The Ubuntu operating system library files must have mode 0755 or less permissive."
#   block:
#       - name: "MEDIUM | UBTU-18-010133 | AUDIT | The Ubuntu operating system library files must have mode 0755 or less permissive. | Get library files with mode 0755 or less"
#         shell: find /lib /lib64 /usr/lib -perm /022 -type f -exec stat -c "%n %a" '{}' \; | cut -d" " -f1
#         changed_when: false
#         failed_when: false
#         register: ubtu_18_010133_lib_files

#       - name: "MEDIUM | UBTU-18-010133 | PATCH | The Ubuntu operating system library files must have mode 0755 or less permissive. | Set library files with mode 0755 or more restrictive"
#         file:
#             path: "{{ item }}"
#             mode: "{{ ubtu18stig_lib_file_perms }}"
#         with_items:
#             "{{ ubtu_18_010133_lib_files.stdout_lines }}"
#         when: ubtu_18_010133_lib_files.stdout | length > 0
#   when:
#       - ubtu_18_010133
#   tags:
#       - UBTU-18-010133
#       - CAT2
#       - CCI-001499
#       - SRG-OS-000259-GPOS-00100
#       - SV-219198r802358_rule
#       - V-219198
#       - permissions
- name: |
    "MEDIUM | UBTU-18-010134 | PATCH | The Ubuntu operating system library directories must have mode 0755 or less permissive."
    "MEDIUM | UBTU-18-010136 | PATCH | The Ubuntu operating system library directories must be owned by root."
    "MEDIUM | UBTU-18-010138 | PATCH | The Ubuntu operating system library directories must be group-owned by root."
  block:
      - name: |
          "MEDIUM | UBTU-18-010134 | AUDIT | The Ubuntu operating system library directories must have mode 0755 or less permissive. | Get library directories with 750 or less"
          "MEDIUM | UBTU-18-010136 | AUDIT | The Ubuntu operating system library directories must be owned by root. | Get OS library directories not owned by root"
          "MEDIUM | UBTU-18-010138 | AUDIT | The Ubuntu operating system library directories must be group-owned by root. | Get OS library directories not group-owned by root"
        shell: find /lib /lib64 /usr/lib \( ! -group root -o ! -user root -o -perm /022 \) -type d -exec stat -c "%n" '{}' \;
        changed_when: false
        failed_when: false
        register: ubtu_18_010134_lib_dirs

      - name: |
          "MEDIUM | UBTU-18-010134 | PATCH | The Ubuntu operating system library directories must have mode 0755 or less permissive. | Set library directories with 755 or more restrictive"
          "MEDIUM | UBTU-18-010136 | PATCH | The Ubuntu operating system library directories must be owned by root. | Set OS library directories not owned by root"
          "MEDIUM | UBTU-18-010138 | PATCH | The Ubuntu operating system library directories must be group-owned by root. | Set OS library directories not group-owned by root"
        file:
            path: "{{ item }}"
            owner: "{{ ubtu_18_010136 | ternary('root',omit) }}"
            group: "{{ ubtu_18_010138 | ternary('root',omit) }}"
            mode: "{{ ubtu_18_010134 | ternary(ubtu18stig_lib_dir_perms,omit) }}"
            state: directory
        with_items:
            - "{{ ubtu_18_010134_lib_dirs.stdout_lines }}"
        when: ubtu_18_010134_lib_dirs.stdout | length > 0
  when:
      - ubtu_18_010134 or
        ubtu_18_010136 or
        ubtu_18_010138
  tags:
      - UBTU-18-010134
      - UBTU-18-010136
      - UBTU-18-010138
      - CAT2
      - CCI-001499
      - SRG-OS-000259-GPOS-00100
      - SV-219199r610963_rule
      - SV-219201r610963_rule
      - SV-219203r610963_rule
      - V-219199
      - V-219201
      - V-219203
      - permissions

# - name: "MEDIUM | UBTU-18-010134 | PATCH | The Ubuntu operating system library directories must have mode 0755 or less permissive."
#   block:
#       - name: "MEDIUM | UBTU-18-010134 | AUDIT | The Ubuntu operating system library directories must have mode 0755 or less permissive. | Get library directories with 750 or less"
#         shell: find /lib /lib64 /usr/lib -perm /022 -type d -exec stat -c "%n %a" '{}' \; | cut -d" " -f1
#         changed_when: false
#         failed_when: false
#         register: ubtu_18_010134_lib_dirs

#       - debug: var=ubtu_18_010134_lib_dirs

#       - name: "MEDIUM | UBTU-18-010134 | PATCH | The Ubuntu operating system library directories must have mode 0755 or less permissive. | Set library directories with 755 or more restrictive"
#         file:
#             path: "{{ item }}"
#             mode: "{{ ubtu18stig_lib_dir_perms }}"
#             state: directory
#         loop:
#             - "{{ ubtu_18_010134_lib_dirs.stdout_lines }}"
#         when: ubtu_18_010134_lib_dirs.stdout | length > 0
#   when:
#       - ubtu_18_010134
#   tags:
#       - UBTU-18-010134
#       - CAT2
#       - CCI-001499
#       - SRG-OS-000259-GPOS-00100
#       - SV-219199r610963_rule
#       - V-219199
#       - permissions

# - name: "MEDIUM | UBTU-18-010135 | PATCH | The Ubuntu operating system library files must be owned by root."
#   block:
#       - name: "MEDIUM | UBTU-18-010135 | AUDIT | The Ubuntu operating system library files must be owned by root. | Get OS files not owned by root"
#         shell: find /lib /usr/lib /lib64 ! -user root -type f -exec stat -c "%n %U" '{}' \; | cut -d" " -f1
#         changed_when: false
#         failed_when: false
#         register: ubtu_18_010135_lib_files_owner

#       - name: "MEDIUM | UBTU-18-010135 | PATCH | The Ubuntu operating system library files must be owned by root. | Set OS files to be owned by root"
#         file:
#             path: "{{ item }}"
#             owner: root
#         with_items:
#             - "{{ ubtu_18_010135_lib_files_owner.stdout_lines }}"
#         when: ubtu_18_010135_lib_files_owner.stdout | length > 0
#   when:
#       - ubtu_18_010135
#   tags:
#       - UBTU-18-010135
#       - CAT2
#       - CCI-001499
#       - SRG-OS-000259-GPOS-00100
#       - SV-219200r610963_rule
#       - V-219200
#       - permissions

# - name: "MEDIUM | UBTU-18-010136 | PATCH | The Ubuntu operating system library directories must be owned by root."
#   block:
#       - name: "MEDIUM | UBTU-18-010136 | AUDIT | The Ubuntu operating system library directories must be owned by root. | Get OS library directories not owned by root"
#         shell: find /lib /usr/lib /lib64 ! -user root -type d -exec stat -c "%n %U" '{}' \; | cut -d" " -f1
#         changed_when: false
#         failed_when: false
#         register: ubtu_18_010136_lib_files_owner

#       - name: "MEDIUM | UBTU-18-010136 | PATCH | The Ubuntu operating system library directories must be owned by root. | Set OS library directories not owned by root"
#         file:
#             path: "{{ item }}"
#             owner: root
#             state: directory
#         with_items:
#             - "{{ ubtu_18_010136_lib_files_owner.stdout_lines }}"
#         when: ubtu_18_010136_lib_files_owner.stdout | length > 0
#   when:
#       - ubtu_18_010136
#   tags:
#       - UBTU-18-010136
#       - CAT2
#       - CCI-001499
#       - SRG-OS-000259-GPOS-00100
#       - SV-219201r610963_rule
#       - V-219201
#       - permissions

# - name: "MEDIUM | UBTU-18-010137 | PATCH | The Ubuntu operating system library files must be group-owned by root."
#   block:
#       - name: "MEDIUM | UBTU-18-010137 | AUDIT | The Ubuntu operating system library files must be group-owned by root. | Get OS library files not group-owned by root"
#         shell: find /lib /usr/lib /lib64 ! -group root -type f -exec stat -c "%n %G" '{}' \; | cut -d" " -f1
#         changed_when: false
#         failed_when: false
#         register: ubtu_18_010137_lib_files_group

#       - name: "MEDIUM | UBTU-18-010137 | PATCH | The Ubuntu operating system library files must be group-owned by root. | Set OS library files not group-owned by root"
#         file:
#             path: "{{ item }}"
#             group: root
#         with_items:
#             - "{{ ubtu_18_010137_lib_files_group.stdout_lines }}"
#         when: ubtu_18_010137_lib_files_group.stdout | length > 0
#   when:
#       - ubtu_18_010137
#   tags:
#       - UBTU-18-010137
#       - CAT2
#       - CCI-001499
#       - SRG-OS-000259-GPOS-00100
#       - SV-219202r802361_rule
#       - V-219202
#       - permissions

# - name: "MEDIUM | UBTU-18-010138 | PATCH | The Ubuntu operating system library directories must be group-owned by root."
#   block:
#       - name: "MEDIUM | UBTU-18-010138 | AUDIT | The Ubuntu operating system library directories must be group-owned by root. | Get OS library directories not group-owned by root"
#         shell: find /lib /usr/lib /lib64 ! -group root -type d -exec stat -c "%n %G" '{}' \; | cut -d" " -f1
#         changed_when: false
#         failed_when: false
#         register: ubtu_18_010138_lib_dirs_group
#       - debug: var=ubtu_18_010138_lib_dirs_group
#       - name: "MEDIUM | UBTU-18-010138 | PATCH | The Ubuntu operating system library directories must be group-owned by root. | Set OS library directories not group-owned by root"
#         file:
#             name: "{{ item }}"
#             group: root
#             state: directory
#         with_items:
#             - "{{ ubtu_18_010138_lib_dirs_group.stdout_lines }}"
#         when: ubtu_18_010138_lib_dirs_group.stdout | length > 0
#   when:
#       - ubtu_18_010138
#   tags:
#       - UBTU-18-010138
#       - CAT2
#       - CCI-001499
#       - SRG-OS-000259-GPOS-00100
#       - SV-219203r610963_rule
#       - V-219203
#       - permissions

- name: |
    "MEDIUM | UBTU-18-010139 | PATCH | The Ubuntu operating system must have system commands set to a mode of 0755 or less permissive."
    "MEDIUM | UBTU-18-010141 | PATCH | The Ubuntu operating system must have system commands owned by root."
    "MEDIUM | UBTU-18-010143 | PATCH | The Ubuntu operating system must have system commands group-owned by root or a system account."
  block:
      - name: |
          "MEDIUM | UBTU-18-010139 | AUDIT | The Ubuntu operating system must have system commands set to a mode of 0755 or less permissive. | Get OS commands with mode less than 755"
          "MEDIUM | UBTU-18-010141 | AUDIT | The Ubuntu operating system must have system commands owned by root. | Get OS commands not owned by root"
          "MEDIUM | UBTU-18-010143 | PATCH | The Ubuntu operating system must have system commands group-owned by root or a system account. | Get OS commands not group-owned by root"
        shell: find -L /bin /sbin /usr/bin /usr/sbin /usr/local/bin /usr/local/sbin \( ! -group root -o ! -user root -o -perm /022 \) -type f -exec stat -c "%n" '{}' \;
        changed_when: false
        failed_when: false
        register: ubtu_18_010139_commands_perms

      - name: |
          "MEDIUM | UBTU-18-010139 | PATCH | The Ubuntu operating system must have system commands set to a mode of 0755 or less permissive. | Set OS commands with mode 755 or more restricive"
          "MEDIUM | UBTU-18-010141 | PATCH | The Ubuntu operating system must have system commands owned by root. | Set OS commands not owned by root to owned by root"
          "MEDIUM | UBTU-18-010143 | PATCH | The Ubuntu operating system must have system commands group-owned by root or a system account. | Set OS commands not group-owned by root to root"
        file:
            path: "{{ item }}"
            owner: "{{ ubtu_18_010141 | ternary('root',omit) }}"
            group: "{{ ubtu_18_010143 | ternary('root',omit) }}"
            mode: "{{ ubtu_18_010139 | ternary(ubtu18stig_sys_commands_perms,omit) }}"
        with_items:
            - "{{ ubtu_18_010139_commands_perms.stdout_lines }}"
        when:  ubtu_18_010139_commands_perms.stdout | length > 0
  when:
      - ubtu_18_010139 or
        ubtu_18_010141 or
        ubtu_18_010143
  tags:
      - UBTU-18-010139
      - UBTU-18-010141
      - UBTU-18-010143
      - CAT2
      - CCI-001499
      - SRG-OS-000259-GPOS-00100
      - SV-219204r610963_rule
      - SV-219206r610963_rule
      - SV-219208r832925_rule
      - V-219204
      - V-219206
      - V-219208
      - permissions

# - name: "MEDIUM | UBTU-18-010139 | PATCH | The Ubuntu operating system must have system commands set to a mode of 0755 or less permissive."
#   block:
#       - name: "MEDIUM | UBTU-18-010139 | AUDIT | The Ubuntu operating system must have system commands set to a mode of 0755 or less permissive. | Get OS commands with mode less than 755"
#         shell: find -L /bin /sbin /usr/bin /usr/sbin /usr/local/bin /usr/local/sbin -perm /022 -type f -exec stat -c "%n %a" '{}' \; | cut -d" " -f1
#         changed_when: false
#         failed_when: false
#         register: ubtu_18_010139_commands_perms

#       - name: "MEDIUM | UBTU-18-010139 | PATCH | The Ubuntu operating system must have system commands set to a mode of 0755 or less permissive. | Set OS commands with mode 755 or more restricive"
#         file:
#             path: "{{ item }}"
#             mode: "{{ ubtu18stig_sys_commands_perms }}"
#         with_items:
#             - "{{ ubtu_18_010139_commands_perms.stdout_lines }}"
#         when:  ubtu_18_010139_commands_perms.stdout | length > 0
#   when:
#       - ubtu_18_010139
#   tags:
#       - UBTU-18-010139
#       - CAT2
#       - CCI-001499
#       - SRG-OS-000259-GPOS-00100
#       - SV-219204r610963_rule
#       - V-219204
#       - permissions

- name: |
    "MEDIUM | UBTU-18-010140 | PATCH | The Ubuntu operating system must have directories that contain system commands set to a mode of 0755 or less permissive."
    "MEDIUM | UBTU-18-010142 | PATCH | The Ubuntu operating system must have directories that contain system commands owned by root."
    "MEDIUM | UBTU-18-010144 | PATCH | The Ubuntu operating system must have directories that contain system commands group-owned by root."
  block:
      - name: |
          "MEDIUM | UBTU-18-010140 | AUDIT | The Ubuntu operating system must have directories that contain system commands set to a mode of 0755 or less permissive. | Get OS command directories with mode less than 755"
          "MEDIUM | UBTU-18-010142 | AUDIT | The Ubuntu operating system must have directories that contain system commands owned by root. | Get OS command dirs not owned by root"
          "MEDIUM | UBTU-18-010144 | PATCH | The Ubuntu operating system must have directories that contain system commands group-owned by root. | Get OS command dirs not group-owned by root"
        shell: find -L /bin /sbin /usr/bin /usr/sbin /usr/local/bin /usr/local/sbin \( ! -group root -o ! -user root -o -perm /022 \) -type d -exec stat -c "%n" '{}' \;
        changed_when: false
        failed_when: false
        register: ubtu_18_010140_command_dir_perms

      - name: |
          "MEDIUM | UBTU-18-010140 | PATCH | The Ubuntu operating system must have directories that contain system commands set to a mode of 0755 or less permissive. | Set OS command directories with mode 755 or more restricive"
          "MEDIUM | UBTU-18-010142 | PATCH | The Ubuntu operating system must have directories that contain system commands owned by root. | Set OS command dirs not owned by root to root"
          "MEDIUM | UBTU-18-010144 | PATCH | The Ubuntu operating system must have directories that contain system commands group-owned by root. | Set OS command dirs not group-owned by root to root"
        file:
            path: "{{ item }}"
            owner: "{{ ubtu_18_010142 | ternary('root',omit) }}"
            group: "{{ ubtu_18_010144 | ternary('root',omit) }}"
            mode: "{{ ubtu_18_010140 | ternary(ubtu18stig_sys_comm_dir_perms,omit) }}"
            state: directory
        with_items:
            - "{{ ubtu_18_010140_command_dir_perms.stdout_lines }}"
        when: ubtu_18_010140_command_dir_perms.stdout | length > 0
  when:
      - ubtu_18_010140 or
        ubtu_18_010142 or
        ubtu_18_010144
  tags:
      - UBTU-18-010140
      - UBTU-18-010142
      - UBTU-18-010144
      - CAT2
      - CCI-001499
      - SRG-OS-000259-GPOS-00100
      - SV-219205r610963_rule
      - SV-219207r610963_rule
      - SV-219209r610963_rule
      - V-219205
      - V-219207
      - V-219209
      - permissions


# - name: "MEDIUM | UBTU-18-010140 | PATCH | The Ubuntu operating system must have directories that contain system commands set to a mode of 0755 or less permissive."
#   block:
#       - name: "MEDIUM | UBTU-18-010140 | AUDIT | The Ubuntu operating system must have directories that contain system commands set to a mode of 0755 or less permissive. | Get OS command directories with mode less than 755"
#         shell: find -L /bin /sbin /usr/bin /usr/sbin /usr/local/bin /usr/local/sbin -perm /022 -type d -exec stat -c "%n %a" '{}' \; | cut -d" " -f1
#         changed_when: false
#         failed_when: false
#         register: ubtu_18_010140_command_dir_perms

#       - name: "MEDIUM | UBTU-18-010140 | PATCH | The Ubuntu operating system must have directories that contain system commands set to a mode of 0755 or less permissive. | Set OS command directories with mode 755 or more restricive"
#         file:
#             path: "{{ item }}"
#             mode: "{{ ubtu18stig_sys_comm_dir_perms }}"
#             state: directory
#         with_items:
#             - "{{ ubtu_18_010140_command_dir_perms.stdout_lines }}"
#         when: ubtu_18_010140_command_dir_perms.stdout | length > 0
#   when:
#       - ubtu_18_010140
#   tags:
#       - UBTU-18-010140
#       - CAT2
#       - CCI-001499
#       - SRG-OS-000259-GPOS-00100
#       - SV-219205r610963_rule
#       - V-219205
#       - permissions

# - name: "MEDIUM | UBTU-18-010141 | PATCH | The Ubuntu operating system must have system commands owned by root."
#   block:
#         - name: "MEDIUM | UBTU-18-010141 | AUDIT | The Ubuntu operating system must have system commands owned by root. | Get OS commands not owned by root"
#           shell: find -L /bin /sbin /usr/bin /usr/sbin /usr/local/bin /usr/local/sbin ! -user root -type f -exec stat -c "%n %U" '{}' \; | cut -d" " -f1
#           changed_when: false
#           failed_when: false
#           register: ubtu_18_010141_sys_comm_files_owner

#         - name: "MEDIUM | UBTU-18-010141 | PATCH | The Ubuntu operating system must have system commands owned by root. | Set OS commands not owned by root to owned by root"
#           file:
#               path: "{{ item }}"
#               owner: root
#           with_items:
#               - "{{ ubtu_18_010141_sys_comm_files_owner.stdout_lines }}"
#           when: ubtu_18_010141_sys_comm_files_owner.stdout | length > 0
#   when:
#       - ubtu_18_010141
#   tags:
#       - UBTU-18-010141
#       - CAT2
#       - CCI-001499
#       - SRG-OS-000259-GPOS-00100
#       - SV-219206r610963_rule
#       - V-219206
#       - permissions

# - name: "MEDIUM | UBTU-18-010142 | PATCH | The Ubuntu operating system must have directories that contain system commands owned by root."
#   block:
#       - name: "MEDIUM | UBTU-18-010142 | AUDIT | The Ubuntu operating system must have directories that contain system commands owned by root. | Get OS command dirs not owned by root"
#         shell: find -L /bin /sbin /usr/bin /usr/sbin /usr/local/bin /usr/local/sbin ! -user root -type d -exec stat -c "%n %U" '{}' \; | cut -d" " -f1
#         changed_when: false
#         failed_when: false
#         register: ubtu_18_010142_sys_comm_dir_owner

#       - debug: var=ubtu_18_010142_sys_comm_dir_owner
#       - name: "MEDIUM | UBTU-18-010142 | PATCH | The Ubuntu operating system must have directories that contain system commands owned by root. | Set OS command dirs not owned by root to root"
#         file:
#             path: "{{ item }}"
#             owner: root
#             state: directory
#         with_items:
#             - "{{ ubtu_18_010142_sys_comm_dir_owner.stdout_lines }}"
#         when: ubtu_18_010142_sys_comm_dir_owner.stdout | length > 0
#   when:
#       - ubtu_18_010142
#   tags:
#       - UBTU-18-010142
#       - CAT2
#       - CCI-001499
#       - SRG-OS-000259-GPOS-00100
#       - SV-219207r610963_rule
#       - V-219207
#       - permissions

# - name: "MEDIUM | UBTU-18-010143 | PATCH | The Ubuntu operating system must have system commands group-owned by root or a system account."
#   block:
#       - name: "MEDIUM | UBTU-18-010143 | PATCH | The Ubuntu operating system must have system commands group-owned by root or a system account. | Get OS commands not group-owned by root"
#         shell: find -L /bin /sbin /usr/bin /usr/sbin /usr/local/bin /usr/local/sbin ! -group root -type f -exec stat -c "%n" '{}' \;
#         changed_when: false
#         failed_when: false
#         register: ubtu_18_010143_sys_comm_files_group

#       - debug: var=ubtu_18_010143_sys_comm_files_group

#       - name: "MEDIUM | UBTU-18-010143 | PATCH | The Ubuntu operating system must have system commands group-owned by root or a system account. | Set OS commands not group-owned by root to root"
#         file:
#             path: "{{ item }}"
#             group: root
#         with_items:
#             - "{{ ubtu_18_010143_sys_comm_files_group.stdout_lines }}"
#         when: ubtu_18_010143_sys_comm_files_group.stdout | length > 0
#   when:
#       - ubtu_18_010143
#   tags:
#       - UBTU-18-010143
#       - CAT2
#       - CCI-001499
#       - SRG-OS-000259-GPOS-00100
#       - SV-219208r832925_rule
#       - V-219208
#       - permessions

# - name: "MEDIUM | UBTU-18-010144 | PATCH | The Ubuntu operating system must have directories that contain system commands group-owned by root."
#   block:
#       - name: "MEDIUM | UBTU-18-010144 | PATCH | The Ubuntu operating system must have directories that contain system commands group-owned by root. | Get OS command dirs not group-owned by root"
#         shell: find -L /bin /sbin /usr/bin /usr/sbin /usr/local/bin /usr/local/sbin ! -group root -type d -exec stat -c "%n" '{}' \;
#         changed_when: false
#         failed_when: false
#         register: ubtu_18_010144_sys_comm_dirs_group

#       - name: "MEDIUM | UBTU-18-010144 | PATCH | The Ubuntu operating system must have directories that contain system commands group-owned by root."
#         file:
#             path: "{{ item }}"
#             group: root
#             state: directory
#         with_items:
#             - "{{ ubtu_18_010144_sys_comm_dirs_group.stdout_lines }}"
#         when: ubtu_18_010144_sys_comm_dirs_group.stdout | length > 0
#   when:
#       - ubtu_18_010144
#   tags:
#       - UBTU-18-010144
#       - CAT2
#       - CCI-001499
#       - SRG-OS-000259-GPOS-00100
#       - SV-219209r610963_rule
#       - V-219209
#       - permissions
